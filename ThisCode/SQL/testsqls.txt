-- rootユーザーでの実行
CREATE USER 'testuser1'@'localhost' IDENTIFIED BY 'password'
COMMENT 'beginuser by noob';
GRANT USAGE ON *.* TO 'testuser1'@'localhost';
GRANT ALL ON *.* TO 'testuser1'@'localhost';


-- AWS testuser1 
CREATE USER 'testuser1'@'%' IDENTIFIED BY 'password';

GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, PROCESS, REFERENCES, INDEX, ALTER, SHOW DATABASES, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER ON *.* TO 'testuser1'@'%' WITH GRANT OPTION;

UNINSTALL PLUGIN validate_password;

FLUSH PRIVILEGE;

mysql -u testuser1 -p -h エンドポイント



-- 実行してもしなくても
SELECT user, host FROM mysql.user;

-- testuser1での実行が好ましい
CREATE DATABASE thiscord;
USE thiscord;

drop table admin_user;
drop table us_relationship;
drop table message;
drop table text_channel;
drop table server;
drop table account;


-- ユーザーの情報
CREATE TABLE account (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    mailaddress VARCHAR(200),
    password VARCHAR(24),
    user_name VARCHAR(50),
    user_icon VARCHAR(500)
);

-- サーバーの情報
CREATE TABLE server (
    server_id INT AUTO_INCREMENT PRIMARY KEY,
    server_name VARCHAR(100),
    user_id INT,
    server_icon VARCHAR(500),
    FOREIGN KEY (user_id) REFERENCES account(user_id)
);

-- テキストチャンネルのデータ
CREATE TABLE text_channel (
	channel_id INT AUTO_INCREMENT PRIMARY KEY,
	channel_name VARCHAR(50),
	server_id INT,
	FOREIGN KEY (server_id) REFERENCES server(server_id)
);

-- メッセージの履歴
CREATE TABLE message (
	message_id INT AUTO_INCREMENT PRIMARY KEY,
	user_id INT,
	channel_id INT,
	send_date VARCHAR(50),
	message VARCHAR(500),
	FOREIGN KEY (user_id) REFERENCES account(user_id),
	FOREIGN KEY (channel_id) REFERENCES text_channel(channel_id)
);

-- ユーザーがどのサーバーに参加しているか
CREATE TABLE us_relationship (
    user_id INT,
    server_id INT,
    FOREIGN KEY (user_id) REFERENCES account(user_id),
    FOREIGN KEY (server_id) REFERENCES server(server_id)
);

-- 管理者ユーザーのデータ
CREATE TABLE admin_user (
	user_id INT,
	FOREIGN KEY (user_id) REFERENCES account(user_id)
);

INSERT INTO account (mailaddress, password, user_name, user_icon)
VALUES ('tanaka@gmail.com', 'tanaka', 'tanaka', 'user_icon_url');

INSERT INTO account (mailaddress, password, user_name, user_icon)
VALUES ('ojiisan@gmail.com', 'ojiisan', 'ojiisan', 'user_icon_url');

INSERT INTO account (mailaddress, password, user_name, user_icon)
VALUES ('saigou@gmail.com', 'saigou', 'saigou', 'user_icon_url');


INSERT INTO server (server_name, user_id, server_icon)
VALUES ('勉強サーバー', 1, 'user_icon_url');

INSERT INTO server (server_name, user_id, server_icon)
VALUES ('おじいさん', 1, 'user_icon_url');

INSERT INTO server (server_name, user_id, server_icon)
VALUES ('ゆるゲーム', 1, 'user_icon_url');

INSERT INTO server (server_name, user_id, server_icon)
VALUES ('APEX', 1, 'user_icon_url');

INSERT INTO server (server_name, user_id, server_icon)
VALUES ('valorant', 2, 'user_icon_url');


INSERT INTO us_relationship (user_id, server_id) 
VALUES (1, 1);

INSERT INTO us_relationship (user_id, server_id) 
VALUES (1, 2);

INSERT INTO us_relationship (user_id, server_id) 
VALUES (1, 3);

INSERT INTO us_relationship (user_id, server_id) 
VALUES (1, 4);

INSERT INTO us_relationship (user_id, server_id) 
VALUES (2, 5);

INSERT INTO us_relationship (user_id, server_id) 
VALUES (2, 1);


INSERT INTO text_channel (channel_name, server_id) 
VALUES ('Java' 1);

INSERT INTO text_channel (channel_name, server_id) 
VALUES ('勉強', 1);

INSERT INTO text_channel (channel_name, server_id) 
VALUES ('ゲーム', 1);



--　複合主キーver
CREATE TABLE server_data (
    discord_server_id VARCHAR(20),
    server_name VARCHAR(100),
    host_id VARCHAR(20),
    server_icon VARCHAR(500),
    server_member_id VARCHAR(20),
    PRIMARY KEY(discord_server_id, server_member_id),
    FOREIGN KEY(server_member_id)
    REFERENCES user_data(discord_user_id)
    ON UPDATE CASCADE ON DELETE RESTRICT
);
