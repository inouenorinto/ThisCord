<!DOCTYPE html>
<html>

<head>
	<title>WebSocket Chat</title>
	<meta charset="utf-8">
</head>

<body>
	<h3>チャットルーム選択しろ:</h3>
	<select id="roomSelect">
		<option value="room1">Room 1</option>
		<option value="room2">Room 2</option>
		<option value="room3">Room 3</option>
	</select>

	<button onclick="joinRoom()">ルームに参加</button>

	<div id="chat" style="display:none;">
		<input type="text" id="message" placeholder="メッセージを入力">
		<button onclick="sendMessage()">送信</button><br>
	</div>
	<div id="res">
		
	</div>

	<script>
		let room = null;
		const roomSelect = document.getElementById("roomSelect");
		const chatDiv = document.getElementById("chat");
		let chatSocket = null;
		let username = null;

		async function joinRoom() {
			room = roomSelect.value;
			//roomSelect.disabled = true;
			chatDiv.style.display = "block";

			try {
				const response = await fetch("/ThisCord/get-username");
				if (response.ok) {
					username = await response.text();
				} else {
					console.error("ユーザー名を取得できねえ");
				}
			} catch (error) {
				console.error("エラー: " + error);
				return;
			}

			console.log("ユーザー名: " + username);

			chatSocket = new WebSocket(`ws://172.19.2.130:8080/ThisCord/chat/${room}/${username}`);

			chatSocket.onopen = event => {
				console.log("サーバーに接続した");
			};

			chatSocket.onmessage = event => {
				const chat = document.getElementById("res");
				chat.innerHTML += event.data + "<br>";
			};

			chatSocket.onclose = event => {
				console.log("サーバーから切断した");
			};
		}

		// メッセージを送信する処理
		function sendMessage() {
			const messageInput = document.getElementById("message");
			const message = messageInput.value;
			chatSocket.send(message);
			messageInput.value = "";
		}

		// Enterキーでの送信処理
		chatDiv.addEventListener('keypress', test_ivent);
		function test_ivent(e) {
			if (e.keyCode === 13) {
				sendMessage(); // sendMessageを呼び出してメッセージを送信
			}
		}

	</script>
</body>
</html>